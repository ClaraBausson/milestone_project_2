<!DOCTYPE html>
<meta charset="utf-8">
<style>
    body {
        font: 10px sans-serif;
    }

    .y.axisRight text {
        fill: orange;
    }

    .y.axisLeft text {
        fill: steelblue;
    }

    .axis path,
    .axis line {
        fill: none;
        stroke: #000;
        shape-rendering: crispEdges;
    }

    .bar1 {
        fill: steelblue;
    }

    .bar2 {
        fill: orange;
    }

    .x.axis path {
        display: none;
    }
</style>

<body>
    <script src="static/js/external/d3.min.js"></script>
    <script>
        queue()
            .defer(d3.csv, "data/budget.csv")
            .await(drawGraphs);

        function drawGraphs(error, budgetData) {
            var ndx = crossfilter(budgetData);

            show_month_selector(ndx);
            show_income_category_piechart(ndx);
            show_spend_category_piechart(ndx);
            show_category_distribution(ndx);

            dc.renderAll();
        }


        function show_balance_per_month(ndx) {

            function balanceByMonth(dimension, balance) {
                return dimension.group().reduce(
                    function(p, v) {
                        p.total++;
                        if (v.balance == balance) {
                            p.match++;
                        }
                        return p;
                    },
                    function(p, v) {
                        p.total--;
                        if (v.balance == balance) {
                            p.match--;
                        }
                        return p;
                    },
                    function() {
                        return { total: 0, match: 0 };
                    }
                );
            }

            var dim = ndx.dimension(dc.pluck("month"));
            var incomeByMonth = categoryByMonth(dim, "credit amount");
            var expenseByMonth = categoryByMonth(dim, "debit amount");

            dc.barChart("#column_debit-credit_per_month")
                .width(450)
                .height(300)
                .dimension(dim)
                .group(incomeByMonth, "Income")
                .stack(expenseByMonth, "Expenses")
                .valueAccessor(function(d) {
                    if (d.value.total > 0) {
                        return (d.value.match / d.value.total) * 100;
                    }
                    else {
                        return 0;
                    }
                })
                .x(d3.scale.ordinal())
                .xUnits(dc.units.ordinal)
                .legend(dc.legend().x(350).y(20).itemHeight(10).gap(10))
                .margins({ top: 10, right: 100, bottom: 30, left: 30 });
        }
    </script>
